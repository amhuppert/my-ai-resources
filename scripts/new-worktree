#!/bin/bash
set -e

if [ -z "$1" ]; then
  echo "Usage: $0 <branch-name>"
  echo "Example: $0 feat/my-feature"
  exit 1
fi

NEW_BRANCH="$1"
BASE_REF="origin/main"

# Convert branch name to safe directory name (replace / with -)
SAFE_DIR_NAME=$(echo "$NEW_BRANCH" | sed 's/\//-/g')

# Save original repo directory before we change directories
ORIGINAL_DIR="$(git rev-parse --show-toplevel)"
PROJECT_NAME="$(basename "$ORIGINAL_DIR")"

# Base location for all project worktrees. Can be overridden per environment.
WORKTREE_BASE="${GIT_WORKTREE_DIRECTORY:-$HOME/worktrees}"

# Expand a leading "~" to "$HOME" for convenience when set via env var.
case "$WORKTREE_BASE" in
  "~") WORKTREE_BASE="$HOME" ;;
  "~/"*) WORKTREE_BASE="$HOME/${WORKTREE_BASE#~/}" ;;
esac

WORKTREE_ROOT="$WORKTREE_BASE/$PROJECT_NAME"
WORKTREE_DIR="$WORKTREE_ROOT/$SAFE_DIR_NAME"

# Ensure project worktree root exists
mkdir -p "$WORKTREE_ROOT"

echo "Fetching latest from origin..."
git fetch origin

# Determine branch existence
LOCAL_EXISTS=false
REMOTE_EXISTS=false

if git show-ref --verify --quiet "refs/heads/$NEW_BRANCH"; then
  LOCAL_EXISTS=true
fi

if git show-ref --verify --quiet "refs/remotes/origin/$NEW_BRANCH"; then
  REMOTE_EXISTS=true
fi

if [ "$LOCAL_EXISTS" = true ]; then
  # Branch exists locally (cases 2 and 4) — use existing local branch
  echo "Using existing local branch '$NEW_BRANCH'..."
  git worktree add "$WORKTREE_DIR" "$NEW_BRANCH"
elif [ "$REMOTE_EXISTS" = true ]; then
  # Branch exists on remote only (case 3) — create local tracking branch
  echo "Creating local branch '$NEW_BRANCH' tracking 'origin/$NEW_BRANCH'..."
  git worktree add --track -b "$NEW_BRANCH" "$WORKTREE_DIR" "origin/$NEW_BRANCH"
else
  # Branch doesn't exist anywhere (case 1) — create new branch from BASE_REF
  echo "Creating new branch '$NEW_BRANCH' from '$BASE_REF'..."
  git worktree add -b "$NEW_BRANCH" "$WORKTREE_DIR" "$BASE_REF"
fi

cd "$WORKTREE_DIR"

# Delegate environment setup to setup-worktree
ROOT_WORKTREE_PATH="$ORIGINAL_DIR" setup-worktree

echo ""
echo "✓ Worktree created at: $WORKTREE_DIR"
echo "✓ Branch: $NEW_BRANCH"
echo ""
echo "To navigate to the worktree:"
echo "  cd $WORKTREE_DIR"
echo ""
echo "To remove the worktree when done:"
echo "  git worktree remove $WORKTREE_DIR"
