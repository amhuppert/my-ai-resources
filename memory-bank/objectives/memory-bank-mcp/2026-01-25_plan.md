# Memory Bank MCP Server - Implementation Plan

## Overview

Standalone MCP server providing AI agents with structured memory management via per-project SQLite database. Enables hierarchical feature tracking, file/directory associations, requirements, objectives, tasks, and external ticket references.

**Database location**: `.claude/memory-bank.db` (per-project, created on first use)

## Tech Stack

- **Runtime**: Bun
- **MCP**: `@modelcontextprotocol/sdk` ^1.17.5 (stdio transport)
- **Database**: `bun:sqlite` (built-in, zero dependencies)
- **Validation**: `zod` ^3.22.0
- **IDs**: `nanoid` ^5.0.0 (12-char, URL-safe)

## Directory Structure

```
memory-bank-mcp/
├── package.json
├── tsconfig.json
├── src/
│   ├── index.ts              # Entry point, MCP server setup
│   ├── db/
│   │   ├── connection.ts     # DB connection, lazy init
│   │   └── schema.ts         # Table creation SQL
│   ├── schemas/
│   │   ├── common.ts         # Status enum, slug regex, timestamps
│   │   ├── features.ts
│   │   ├── paths.ts          # Files and directories
│   │   ├── requirements.ts
│   │   ├── objectives.ts
│   │   ├── tasks.ts
│   │   └── tickets.ts
│   ├── tools/
│   │   ├── features.ts
│   │   ├── paths.ts          # Files and directories
│   │   ├── requirements.ts
│   │   ├── objectives.ts
│   │   ├── tasks.ts
│   │   ├── tickets.ts
│   │   └── context.ts        # Query and context-building
│   └── utils/
│       ├── id.ts             # nanoid wrapper
│       └── errors.ts         # Custom error classes
└── bin/
    └── memory-bank-mcp       # Compiled executable
```

## Database Schema

```sql
-- Features: hierarchical via slug pattern (feature/sub-feature/...)
CREATE TABLE IF NOT EXISTS features (
  id TEXT PRIMARY KEY,
  slug TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_features_slug ON features(slug);

-- Paths: files and directories (project-relative)
CREATE TABLE IF NOT EXISTS paths (
  id TEXT PRIMARY KEY,
  path TEXT UNIQUE NOT NULL,
  type TEXT NOT NULL CHECK(type IN ('file', 'directory')),
  description TEXT,
  use_when TEXT NOT NULL DEFAULT '[]',
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_paths_path ON paths(path);
CREATE INDEX IF NOT EXISTS idx_paths_type ON paths(type);

-- Feature-Paths junction
CREATE TABLE IF NOT EXISTS feature_paths (
  feature_id TEXT NOT NULL REFERENCES features(id) ON DELETE CASCADE,
  path_id TEXT NOT NULL REFERENCES paths(id) ON DELETE CASCADE,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  PRIMARY KEY (feature_id, path_id)
);

-- Requirements linked to features
CREATE TABLE IF NOT EXISTS requirements (
  id TEXT PRIMARY KEY,
  feature_id TEXT NOT NULL REFERENCES features(id) ON DELETE CASCADE,
  text TEXT NOT NULL,
  notes TEXT NOT NULL DEFAULT '[]',
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_requirements_feature ON requirements(feature_id);

-- Objectives with status tracking
CREATE TABLE IF NOT EXISTS objectives (
  id TEXT PRIMARY KEY,
  slug TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'in_progress', 'completed')),
  plan_file_path TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_objectives_slug ON objectives(slug);
CREATE INDEX IF NOT EXISTS idx_objectives_status ON objectives(status);

-- Tasks ordered within objectives
CREATE TABLE IF NOT EXISTS tasks (
  id TEXT PRIMARY KEY,
  objective_id TEXT NOT NULL REFERENCES objectives(id) ON DELETE CASCADE,
  text TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'in_progress', 'completed')),
  "order" INTEGER NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_tasks_objective ON tasks(objective_id);

-- External tickets (JIRA, etc.)
CREATE TABLE IF NOT EXISTS tickets (
  id TEXT PRIMARY KEY,
  key TEXT UNIQUE NOT NULL,
  title TEXT,
  description TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_tickets_key ON tickets(key);

-- Objective-Features junction
CREATE TABLE IF NOT EXISTS objective_features (
  objective_id TEXT NOT NULL REFERENCES objectives(id) ON DELETE CASCADE,
  feature_id TEXT NOT NULL REFERENCES features(id) ON DELETE CASCADE,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  PRIMARY KEY (objective_id, feature_id)
);

-- Objective-Tickets junction
CREATE TABLE IF NOT EXISTS objective_tickets (
  objective_id TEXT NOT NULL REFERENCES objectives(id) ON DELETE CASCADE,
  ticket_id TEXT NOT NULL REFERENCES tickets(id) ON DELETE CASCADE,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  PRIMARY KEY (objective_id, ticket_id)
);
```

## Validation Rules

**Slugs**: `^[a-z0-9]+(-[a-z0-9]+)*(\/[a-z0-9]+(-[a-z0-9]+)*)*$`

- Lowercase alphanumeric with hyphens
- Forward slashes for hierarchy
- Examples: `auth`, `auth/oauth`, `user-management/roles`

**Status**: `'pending' | 'in_progress' | 'completed'`

**PathType**: `'file' | 'directory'`

**Paths**: Project-relative, normalized (no leading `./`, no trailing `/`)

**UseWhen**: JSON array of free-text strings (AI-interpreted conditions)

**IDs**: 12-character nanoid (URL-safe)

## MCP Tools

### Features

| Tool              | Input                                          | Batch | Description                                         |
| ----------------- | ---------------------------------------------- | ----- | --------------------------------------------------- |
| `create_features` | `{ features: [{ slug, name, description? }] }` | Yes   | Create features                                     |
| `get_feature`     | `{ slug }`                                     | No    | Get feature by slug                                 |
| `list_features`   | `{ parent_slug? }`                             | No    | List features, optionally filtered by parent prefix |
| `update_feature`  | `{ slug, name?, description? }`                | No    | Update feature                                      |
| `delete_feature`  | `{ slug }`                                     | No    | Delete feature (cascades to links)                  |

### Paths (Files & Directories)

| Tool                       | Input                                                            | Batch | Description                     |
| -------------------------- | ---------------------------------------------------------------- | ----- | ------------------------------- |
| `create_paths`             | `{ paths: [{ path, type, description?, use_when?: string[] }] }` | Yes   | Create files/directories        |
| `get_path`                 | `{ id } \| { path }`                                             | No    | Get path by ID or path string   |
| `list_paths`               | `{ feature_slug?, type? }`                                       | No    | List paths, optionally filtered |
| `update_path`              | `{ id, description?, use_when? }`                                | No    | Update path metadata            |
| `delete_path`              | `{ id }`                                                         | No    | Delete path (cascades to links) |
| `link_paths_to_feature`    | `{ feature_slug, path_ids: string[] }`                           | Yes   | Link paths to feature           |
| `unlink_path_from_feature` | `{ feature_slug, path_id }`                                      | No    | Remove path-feature link        |

### Requirements

| Tool                  | Input                                                          | Batch | Description                   |
| --------------------- | -------------------------------------------------------------- | ----- | ----------------------------- |
| `create_requirements` | `{ feature_slug, requirements: [{ text, notes?: string[] }] }` | Yes   | Create requirements           |
| `get_requirement`     | `{ id }`                                                       | No    | Get requirement by ID         |
| `list_requirements`   | `{ feature_slug }`                                             | No    | List requirements for feature |
| `update_requirement`  | `{ id, text?, notes? }`                                        | No    | Update requirement            |
| `delete_requirement`  | `{ id }`                                                       | No    | Delete requirement            |

### Objectives

| Tool                            | Input                                                     | Batch | Description                           |
| ------------------------------- | --------------------------------------------------------- | ----- | ------------------------------------- |
| `create_objective`              | `{ slug, name, description?, status?, plan_file_path? }`  | No    | Create objective                      |
| `get_objective`                 | `{ slug }`                                                | No    | Get objective by slug                 |
| `list_objectives`               | `{ status? }`                                             | No    | List objectives, optionally by status |
| `update_objective`              | `{ slug, name?, description?, status?, plan_file_path? }` | No    | Update objective                      |
| `delete_objective`              | `{ slug }`                                                | No    | Delete objective (cascades)           |
| `link_objective_to_features`    | `{ objective_slug, feature_slugs: string[] }`             | Yes   | Link objective to features            |
| `unlink_objective_from_feature` | `{ objective_slug, feature_slug }`                        | No    | Remove objective-feature link         |
| `link_objective_to_tickets`     | `{ objective_slug, ticket_keys: string[] }`               | Yes   | Link objective to tickets             |
| `unlink_objective_from_ticket`  | `{ objective_slug, ticket_key }`                          | No    | Remove objective-ticket link          |

### Tasks

| Tool            | Input                                            | Batch | Description                 |
| --------------- | ------------------------------------------------ | ----- | --------------------------- |
| `create_tasks`  | `{ objective_slug, tasks: [{ text, status? }] }` | Yes   | Create tasks (auto-ordered) |
| `get_task`      | `{ id }`                                         | No    | Get task by ID              |
| `list_tasks`    | `{ objective_slug, status? }`                    | No    | List tasks for objective    |
| `update_task`   | `{ id, text?, status? }`                         | No    | Update task                 |
| `delete_task`   | `{ id }`                                         | No    | Delete task                 |
| `reorder_tasks` | `{ objective_slug, task_ids: string[] }`         | No    | Set task order              |

### Tickets

| Tool             | Input                                          | Batch | Description              |
| ---------------- | ---------------------------------------------- | ----- | ------------------------ |
| `create_tickets` | `{ tickets: [{ key, title?, description? }] }` | Yes   | Create tickets           |
| `get_ticket`     | `{ key }`                                      | No    | Get ticket by key        |
| `list_tickets`   | `{}`                                           | No    | List all tickets         |
| `update_ticket`  | `{ key, title?, description? }`                | No    | Update ticket            |
| `delete_ticket`  | `{ key }`                                      | No    | Delete ticket (cascades) |

### Context & Query

| Tool                    | Input                                           | Description                                                  |
| ----------------------- | ----------------------------------------------- | ------------------------------------------------------------ |
| `get_feature_context`   | `{ slug }`                                      | Feature with paths (incl. use_when), requirements            |
| `get_objective_context` | `{ slug }`                                      | Objective with tasks, linked features, linked tickets        |
| `find_relevant_paths`   | `{ query, feature_slugs?: string[], type? }`    | Search paths by description/use_when matching query          |
| `build_context`         | `{ objective_slug?, feature_slugs?: string[] }` | Comprehensive markdown context for objective and/or features |

## Error Handling

**Validation errors** (bad input, not found, constraint violation): Return structured response with `{ success: false, error: { type, message } }`.

**System errors** (DB connection, file system): Throw and let MCP framework handle.

Error types: `validation_error`, `not_found`, `constraint_violation`, `db_error`

## Tool Response Format

**Success**:

```json
{
  "success": true,
  "data": { ... }
}
```

**Error**:

```json
{
  "success": false,
  "error": {
    "type": "not_found",
    "message": "Feature 'unknown-slug' not found"
  }
}
```

## Implementation Order

1. **Project setup**: package.json, tsconfig.json, directory structure
2. **Utils**: `src/utils/id.ts` (nanoid), `src/utils/errors.ts`
3. **Schemas**: `src/schemas/common.ts`, then entity schemas
4. **Database**: `src/db/schema.ts` (SQL), `src/db/connection.ts` (lazy init)
5. **Tools - Features**: Full CRUD in `src/tools/features.ts`
6. **Tools - Paths**: CRUD + linking in `src/tools/paths.ts`
7. **Tools - Requirements**: CRUD in `src/tools/requirements.ts`
8. **Tools - Objectives**: CRUD + linking in `src/tools/objectives.ts`
9. **Tools - Tasks**: CRUD + reorder in `src/tools/tasks.ts`
10. **Tools - Tickets**: CRUD in `src/tools/tickets.ts`
11. **Tools - Context**: Query/context tools in `src/tools/context.ts`
12. **Server**: Wire up all tools in `src/index.ts`
13. **Build & install**: Compile, link, register in Claude Code settings

## Configuration Files

### package.json

```json
{
  "name": "memory-bank-mcp",
  "version": "1.0.0",
  "type": "module",
  "main": "src/index.ts",
  "bin": {
    "memory-bank-mcp": "./bin/memory-bank-mcp"
  },
  "scripts": {
    "dev": "bun run src/index.ts",
    "build": "bun build src/index.ts --compile --outfile bin/memory-bank-mcp",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.17.5",
    "nanoid": "^5.0.0",
    "zod": "^3.22.0"
  },
  "devDependencies": {
    "@types/bun": "latest",
    "typescript": "^5.0.0"
  }
}
```

### tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "outDir": "dist",
    "declaration": true,
    "types": ["bun-types"]
  },
  "include": ["src/**/*"]
}
```

## Installation

After build:

1. `cd memory-bank-mcp && bun link` (global link)
2. Add to `~/.claude/settings.json`:

```json
{
  "mcpServers": {
    "memory-bank": {
      "command": "memory-bank-mcp",
      "args": []
    }
  }
}
```

## Key Implementation Notes

- **Lazy DB init**: Create `.claude/` directory and `memory-bank.db` on first tool call, not server startup
- **Timestamps**: Use SQLite `datetime('now')` defaults, store as ISO 8601 strings
- **Foreign keys**: Enable with `PRAGMA foreign_keys = ON` on each connection
- **Batch inserts**: Use prepared statements in transaction for efficiency
- **Task ordering**: Auto-assign order on create (max order + 1), reorder_tasks replaces all orders
- **Slug hierarchy**: Parent filtering uses `LIKE 'parent/%'` pattern match
- **Path normalization**: Strip leading `./`, ensure no leading/trailing slashes
- **use_when storage**: JSON array of strings, stored as TEXT, parsed/serialized by application
- **Path type**: Required on create, immutable after creation (cannot change file to directory)
